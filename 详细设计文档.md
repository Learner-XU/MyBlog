# 个人简历与博客网站 - 详细设计文档

## 1. 数据库详细设计

### 1.1 数据表结构

#### users 表 - 用户表
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### resume_sections 表 - 简历章节表
```sql
CREATE TABLE resume_sections (
    id INT PRIMARY KEY AUTO_INCREMENT,
    section_type ENUM('personal_info', 'education', 'experience', 'skills', 'projects') NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    order_index INT DEFAULT 0,
    is_visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### blog_categories 表 - 博客分类表
```sql
CREATE TABLE blog_categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    color VARCHAR(7) DEFAULT '#007bff',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### blog_posts 表 - 博客文章表
```sql
CREATE TABLE blog_posts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    summary TEXT,
    content LONGTEXT NOT NULL,
    category_id INT,
    author_id INT NOT NULL,
    featured_image VARCHAR(500),
    is_published BOOLEAN DEFAULT FALSE,
    view_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL,
    FOREIGN KEY (category_id) REFERENCES blog_categories(id) ON DELETE SET NULL,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### comments 表 - 评论表
```sql
CREATE TABLE comments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    post_id INT NOT NULL,
    author_name VARCHAR(100) NOT NULL,
    author_email VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    is_approved BOOLEAN DEFAULT FALSE,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES blog_posts(id) ON DELETE CASCADE
);
```

#### messages 表 - 留言表
```sql
CREATE TABLE messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    subject VARCHAR(200),
    content TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 1.2 索引设计
```sql
-- 博客文章索引
CREATE INDEX idx_blog_posts_slug ON blog_posts(slug);
CREATE INDEX idx_blog_posts_published ON blog_posts(is_published, published_at);
CREATE INDEX idx_blog_posts_category ON blog_posts(category_id);

-- 评论索引
CREATE INDEX idx_comments_post ON comments(post_id);
CREATE INDEX idx_comments_approved ON comments(is_approved);

-- 简历章节索引
CREATE INDEX idx_resume_sections_type ON resume_sections(section_type);
CREATE INDEX idx_resume_sections_order ON resume_sections(order_index);
```

## 2. API接口详细设计

### 2.1 认证模块 (/api/auth)

#### POST /api/auth/login
**描述**: 管理员登录
**请求体**:
```json
{
    "username": "string",
    "password": "string"
}
```
**响应**:
```json
{
    "access_token": "string",
    "token_type": "bearer",
    "user": {
        "id": 1,
        "username": "admin",
        "full_name": "Administrator"
    }
}
```

#### GET /api/auth/me
**描述**: 获取当前用户信息
**Headers**: `Authorization: Bearer <token>`
**响应**:
```json
{
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "Administrator"
}
```

### 2.2 简历模块 (/api/resume)

#### GET /api/resume
**描述**: 获取完整简历信息
**响应**:
```json
{
    "personal_info": {
        "title": "个人信息",
        "content": "...",
        "order_index": 1
    },
    "education": [
        {
            "title": "教育经历",
            "content": "...",
            "order_index": 2
        }
    ],
    "experience": [...],
    "skills": [...],
    "projects": [...]
}
```

#### PUT /api/resume/{section_id}
**描述**: 更新简历章节
**Headers**: `Authorization: Bearer <token>`
**请求体**:
```json
{
    "title": "string",
    "content": "string",
    "order_index": 1,
    "is_visible": true
}
```

### 2.3 博客模块 (/api/blog)

#### GET /api/blog/posts
**描述**: 获取文章列表
**查询参数**:
- `page`: 页码 (默认: 1)
- `size`: 每页数量 (默认: 10)
- `category`: 分类ID
- `search`: 搜索关键词

**响应**:
```json
{
    "items": [
        {
            "id": 1,
            "title": "文章标题",
            "slug": "article-slug",
            "summary": "文章摘要",
            "category": {
                "id": 1,
                "name": "技术",
                "color": "#007bff"
            },
            "view_count": 123,
            "created_at": "2024-01-01T00:00:00",
            "published_at": "2024-01-01T00:00:00"
        }
    ],
    "total": 50,
    "page": 1,
    "size": 10,
    "pages": 5
}
```

#### GET /api/blog/posts/{slug}
**描述**: 获取文章详情
**响应**:
```json
{
    "id": 1,
    "title": "文章标题",
    "slug": "article-slug",
    "summary": "文章摘要",
    "content": "文章内容...",
    "category": {
        "id": 1,
        "name": "技术"
    },
    "view_count": 124,
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00",
    "published_at": "2024-01-01T00:00:00"
}
```

#### POST /api/blog/posts
**描述**: 创建新文章
**Headers**: `Authorization: Bearer <token>`
**请求体**:
```json
{
    "title": "string",
    "slug": "string (可选，自动生成)",
    "summary": "string",
    "content": "string",
    "category_id": 1,
    "featured_image": "string (可选)",
    "is_published": false
}
```

### 2.4 评论模块 (/api/comments)

#### GET /api/comments/{post_id}
**描述**: 获取文章评论
**查询参数**:
- `page`: 页码
- `size`: 每页数量

#### POST /api/comments
**描述**: 提交评论
**请求体**:
```json
{
    "post_id": 1,
    "author_name": "string",
    "author_email": "string",
    "content": "string"
}
```

### 2.5 管理模块 (/api/admin)

#### GET /api/admin/dashboard
**描述**: 获取仪表板数据
**Headers**: `Authorization: Bearer <token>`
**响应**:
```json
{
    "stats": {
        "total_posts": 25,
        "total_comments": 150,
        "total_messages": 30,
        "total_views": 5000
    },
    "recent_comments": [...],
    "recent_messages": [...]
}
```

## 3. 核心业务逻辑设计

### 3.1 文章发布流程
1. 创建草稿 (`is_published=False`)
2. 编辑内容
3. 设置发布状态 (`is_published=True`)
4. 自动设置 `published_at` 时间戳
5. 生成SEO友好的slug

### 3.2 评论审核机制
1. 用户提交评论 (`is_approved=False`)
2. 管理员后台审核
3. 批准后显示在前端 (`is_approved=True`)
4. 垃圾评论过滤（基于关键词）

### 3.3 访问统计
1. 文章详情页访问时增加view_count
2. 使用IP地址防重复统计（24小时内）
3. 记录访问日志用于分析

## 4. 安全设计详细说明

### 4.1 认证与授权
- JWT Token有效期设置（24小时）
- 密码使用bcrypt哈希
- 敏感操作需要重新验证
- API限流防止暴力攻击

### 4.2 数据验证
- 所有输入使用Pydantic验证
- HTML内容过滤防XSS
- 文件上传安全检查
- SQL注入防护

### 4.3 日志审计
- 记录所有管理操作
- 记录登录失败尝试
- 记录敏感数据修改

## 5. 性能优化设计

### 5.1 数据库优化
- 合理使用索引
- 分页查询优化
- 连接池配置
- 慢查询监控

### 5.2 缓存策略
- Redis缓存热点数据
- 文章内容缓存
- 分类列表缓存
- API响应缓存

### 5.3 前端优化
- 静态资源CDN
- 图片懒加载
- 代码压缩
- 浏览器缓存策略

## 6. 错误处理与日志

### 6.1 统一错误响应格式
```json
{
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "输入数据验证失败",
        "details": {
            "field": ["具体错误信息"]
        }
    }
}
```

### 6.2 日志级别设计
- ERROR: 系统错误、异常
- WARN: 业务警告
- INFO: 重要业务操作
- DEBUG: 调试信息

## 7. 测试策略

### 7.1 单元测试
- 模型层测试
- 业务逻辑测试
- 工具函数测试

### 7.2 集成测试
- API接口测试
- 数据库操作测试
- 认证授权测试

### 7.3 端到端测试
- 用户流程测试
- 管理员操作测试
- 性能测试